name: AutoCoin API Deploy

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'Dockerfile'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      deployment_type:
        description: 'Type of deployment'
        required: true
        default: 'build_and_test'
        type: choice
        options:
          - build_and_test
          - docker_build

jobs:
  build:
    name: "ğŸ—ï¸ Build Application"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew clean bootJar -x test

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar-artifact
          path: build/libs/*.jar
          retention-days: 1

  docker-build:
    name: "ğŸ³ Build & Test Docker"
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: jar-artifact
          path: build/libs/

      - name: Build Docker Image
        run: docker build -t autocoin-api .

      - name: Test Docker Container
        run: |
          docker run -d --name autocoin-test \
            -e SPRING_PROFILES_ACTIVE=prod \
            -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
            -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            -e JWT_EXPIRATION="${{ secrets.JWT_EXPIRATION }}" \
            -e GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
            -e GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
            -e KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}" \
            -e KAKAO_CLIENT_SECRET="${{ secrets.KAKAO_CLIENT_SECRET }}" \
            -e OAUTH2_REDIRECT_URI="${{ secrets.OAUTH2_REDIRECT_URI }}" \
            -e AWS_ACCESS_KEY="${{ secrets.AWS_ACCESS_KEY }}" \
            -e AWS_SECRET_KEY="${{ secrets.AWS_SECRET_KEY }}" \
            -e AWS_S3_BUCKET="${{ secrets.AWS_S3_BUCKET }}" \
            -e AWS_REGION="${{ secrets.AWS_REGION }}" \
            -e UPBIT_API_URL="${{ secrets.UPBIT_API_URL }}" \
            -e UPBIT_ENCRYPTION_KEY="${{ secrets.UPBIT_ENCRYPTION_KEY }}" \
            -e SERP_API_KEY="${{ secrets.SERP_API_KEY }}" \
            -e CORS_ALLOWED_ORIGINS="${{ secrets.CORS_ALLOWED_ORIGINS }}" \
            -e SLACK_NOTIFICATIONS_ENABLED=false \
            -p 8080:8080 \
            autocoin-api
          
          echo "Waiting for container to start..."
          sleep 30
          
          echo "Container status:"
          docker ps -a
          
          echo "Container logs:"
          docker logs autocoin-test
          
          echo "Testing health endpoint..."
          curl -f http://localhost:8080/actuator/health || echo "Health check failed"
          
          docker stop autocoin-test
          docker rm autocoin-test

  prepare-deployment:
    name: "ğŸ› ï¸ Prepare EC2 Environment"
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
      - name: Deploy to EC2 - Environment Setup
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ğŸš€ Starting deployment to EC2..."
            
            # Update system and install Docker if not exists
            sudo apt-get update
            if ! command -v docker &> /dev/null; then
              echo "ğŸ“¦ Installing Docker..."
              sudo apt-get install -y docker.io
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -aG docker ubuntu
            fi
            
            # Create app directory
            mkdir -p ~/autocoin-app
            cd ~/autocoin-app
            
            # Stop existing container if running
            echo "ğŸ›‘ Stopping existing container..."
            docker stop autocoin-api || true
            docker rm autocoin-api || true
            
            # Remove old images to save space
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            # Create environment file with all secrets
            echo "ğŸ“ Creating environment configuration..."
            cat > .env << EOF
            SPRING_PROFILES_ACTIVE=prod
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRATION=${{ secrets.JWT_EXPIRATION }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
            OAUTH2_REDIRECT_URI=${{ secrets.OAUTH2_REDIRECT_URI }}
            AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
            AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}
            AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            UPBIT_API_URL=${{ secrets.UPBIT_API_URL }}
            UPBIT_ENCRYPTION_KEY=${{ secrets.UPBIT_ENCRYPTION_KEY }}
            SERP_API_KEY=${{ secrets.SERP_API_KEY }}
            CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
            SLACK_NOTIFICATIONS_ENABLED=true
            EOF
            
            # Create Dockerfile on EC2
            echo "ğŸ³ Creating Dockerfile..."
            cat > Dockerfile << 'DOCKER_EOF'
            FROM eclipse-temurin:17-jre-alpine
            WORKDIR /app
            RUN apk update && apk add --no-cache curl
            COPY autocoin-api.jar app.jar
            ENV TZ=Asia/Seoul
            EXPOSE 8080
            HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
              CMD curl -f http://localhost:8080/actuator/health || exit 1
            ENTRYPOINT ["java", "-jar", "/app/app.jar"]
            DOCKER_EOF
            
            echo "ğŸ”„ Deployment environment ready!"

  upload-and-deploy:
    name: "ğŸ“¦ Upload JAR & Deploy"
    runs-on: ubuntu-latest
    needs: prepare-deployment
    steps:
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: jar-artifact
          path: build/libs/

      - name: List downloaded files
        run: |
          echo "Current directory contents:"
          ls -la
          echo "Build/libs directory contents:"
          ls -la build/libs/
          echo "Finding JAR files:"
          find . -name "*.jar" -type f

      - name: Upload JAR to EC2 using SSH
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ğŸ“ Preparing to receive JAR file..."
            mkdir -p ~/autocoin-app
            cd ~/autocoin-app
            echo "Ready to receive file"

      - name: Transfer JAR file
        run: |
          echo "Preparing JAR file for transfer..."
          cd build/libs
          JAR_FILE=$(ls *.jar | head -1)
          echo "Found JAR file: $JAR_FILE"
          
          # Create SSH key file
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem
          
          # Transfer file using scp
          scp -i private_key.pem -o StrictHostKeyChecking=no \
            "$JAR_FILE" \
            ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:~/autocoin-app/autocoin-api.jar
          
          echo "âœ… JAR file transferred successfully"
          
          # Clean up
          rm private_key.pem

      - name: Start Application Container
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          script: |
            cd ~/autocoin-app
            
            # List uploaded files
            echo "ğŸ“ Files in autocoin-app directory:"
            ls -la
            
            # Check if JAR file exists
            if [ ! -f "autocoin-api.jar" ]; then
              echo "âŒ autocoin-api.jar not found!"
              exit 1
            fi
            
            echo "âœ… JAR file found: autocoin-api.jar"
            
            # Build Docker image
            echo "ğŸ—ï¸ Building Docker image..."
            docker build -t autocoin-api .
            
            # Run new container with environment file
            echo "ğŸš€ Starting new container..."
            docker run -d \
              --name autocoin-api \
              --env-file .env \
              -p 8080:8080 \
              --restart unless-stopped \
              autocoin-api
            
            echo "âœ… Container started successfully!"

  health-check:
    name: "ğŸ¥ Health Check & Verification"
    runs-on: ubuntu-latest
    needs: upload-and-deploy
    steps:
      - name: Verify Deployment
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          script: |
            # Wait for container to start
            echo "â³ Waiting for application to start..."
            sleep 30
            
            # Check container status
            echo "ğŸ“Š Container status:"
            docker ps -a
            
            # Check application health
            echo "ğŸ¥ Health check:"
            if curl -f http://localhost:8080/actuator/health; then
              echo "âœ… Health check passed!"
            else
              echo "âŒ Health check failed!"
              echo "ğŸ“‹ Container logs:"
              docker logs --tail 50 autocoin-api
              exit 1
            fi
            
            # Show recent logs
            echo "ğŸ“‹ Recent logs:"
            docker logs --tail 20 autocoin-api
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Application is available at http://${{ secrets.EC2_HOST }}:8080"

  deployment-summary:
    name: "ğŸ“‹ Deployment Summary"
    runs-on: ubuntu-latest
    needs: health-check
    if: always()
    steps:
      - name: Print Deployment Summary
        run: |
          echo "âœ… Build completed successfully"
          echo "âœ… Docker image created and tested"
          echo "âœ… Environment prepared on EC2"
          echo "âœ… Application deployed to EC2: ${{ secrets.EC2_HOST }}"
          echo "ğŸŒ Application URL: http://${{ secrets.EC2_HOST }}:8080"
          echo "ğŸ¥ Health Check: http://${{ secrets.EC2_HOST }}:8080/actuator/health"
          echo "ğŸš€ Production deployment completed!"