name: AutoCoin Backend CI/CD

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Run tests
      run: ./gradlew test
      env:
        SPRING_PROFILES_ACTIVE: test
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: build/reports/tests/

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Build with Gradle
      run: ./gradlew build -x test
      env:
        SPRING_PROFILES_ACTIVE: prod
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: jar-artifacts
        path: build/libs/

  deploy-ec2:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: jar-artifacts
        path: build/libs/
    
    - name: Copy deployment scripts to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "scripts/*.sh"
        target: "~"
        strip_components: 1
    
    - name: Make scripts executable
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        debug: true
        script: |
          chmod +x ~/deploy.sh
          chmod +x ~/setup_env.sh
          ls -la ~/*.sh
    
    - name: Setup environment variables
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        debug: true
        envs: DB_USERNAME,DB_PASSWORD,DATABASE_URL,JWT_SECRET,UPBIT_ENCRYPTION_KEY,AWS_ACCESS_KEY,AWS_SECRET_KEY,AWS_S3_BUCKET,AWS_REGION,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,KAKAO_CLIENT_SECRET,SERP_API_KEY
        script: |
          export DB_USERNAME="$DB_USERNAME"
          export DB_PASSWORD="$DB_PASSWORD"
          export DATABASE_URL="$DATABASE_URL"
          export JWT_SECRET="$JWT_SECRET"
          export UPBIT_ENCRYPTION_KEY="$UPBIT_ENCRYPTION_KEY"
          export AWS_ACCESS_KEY="$AWS_ACCESS_KEY"
          export AWS_SECRET_KEY="$AWS_SECRET_KEY"
          export AWS_S3_BUCKET="$AWS_S3_BUCKET"
          export AWS_REGION="$AWS_REGION"
          export GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID"
          export GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET"
          export KAKAO_CLIENT_SECRET="$KAKAO_CLIENT_SECRET"
          export SERP_API_KEY="$SERP_API_KEY"
          sed -i "s/{{DB_USERNAME}}/$DB_USERNAME/g" ~/setup_env.sh
          sed -i "s/{{DB_PASSWORD}}/$DB_PASSWORD/g" ~/setup_env.sh
          sed -i "s/{{DATABASE_URL}}/$DATABASE_URL/g" ~/setup_env.sh
          sed -i "s/{{JWT_SECRET}}/$JWT_SECRET/g" ~/setup_env.sh
          sed -i "s/{{UPBIT_ENCRYPTION_KEY}}/$UPBIT_ENCRYPTION_KEY/g" ~/setup_env.sh
          sed -i "s/{{AWS_ACCESS_KEY}}/$AWS_ACCESS_KEY/g" ~/setup_env.sh
          sed -i "s/{{AWS_SECRET_KEY}}/$AWS_SECRET_KEY/g" ~/setup_env.sh
          sed -i "s/{{AWS_S3_BUCKET}}/$AWS_S3_BUCKET/g" ~/setup_env.sh
          sed -i "s/{{AWS_REGION}}/$AWS_REGION/g" ~/setup_env.sh
          sed -i "s/{{GOOGLE_CLIENT_ID}}/$GOOGLE_CLIENT_ID/g" ~/setup_env.sh
          sed -i "s/{{GOOGLE_CLIENT_SECRET}}/$GOOGLE_CLIENT_SECRET/g" ~/setup_env.sh
          sed -i "s/{{KAKAO_CLIENT_SECRET}}/$KAKAO_CLIENT_SECRET/g" ~/setup_env.sh
          sed -i "s/{{SERP_API_KEY}}/$SERP_API_KEY/g" ~/setup_env.sh
          ~/setup_env.sh
    
    - name: Copy JAR to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "build/libs/*.jar"
        target: "~/app/"
        strip_components: 2
    
    - name: Run deployment script
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        debug: true
        script: |
          cd ~ && ./deploy.sh
    
    - name: Check deployment status
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        debug: true
        script: |
          ps aux | grep java | grep -v grep || echo "No Java processes running"
          curl -v http://localhost:8080/health || echo "Health check failed from server"
    
    - name: Final Health Check
      run: |
        echo "Waiting 10 seconds before final health check..."
        sleep 10
        echo "Performing final health check..."
        curl -v http://${{ secrets.EC2_HOST }}:8080/health || echo "Health check failed but continuing workflow"

  deploy-render:
    needs: build
    runs-on: ubuntu-latest
    if: false  # 현재 비활성화
    # deploy-ec2와 동시에 실행되지 않도록 주석 처리
    # 필요시 deploy-ec2 대신 사용하거나 조건을 다르게 설정
    
    steps:
    - name: Deploy to Render
      run: |
        curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
    
    - name: Wait for deployment
      run: sleep 60
    
    - name: Health Check
      run: |
        # Render 앱 URL로 헬스체크
        curl -f https://your-render-app.onrender.com/health

  notify:
    needs: [deploy-ec2]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify Slack
      if: vars.SLACK_WEBHOOK != ''
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_CHANNEL: deployment
        SLACK_COLOR: ${{ needs.deploy-ec2.result == 'success' && 'good' || 'danger' }}
        SLACK_MESSAGE: |
          AutoCoin Backend Deployment ${{ needs.deploy-ec2.result }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
        SLACK_TITLE: Deployment Status
        SLACK_USERNAME: GitHub Actions
    
    - name: Notify Telegram
      if: vars.TELEGRAM_BOT_TOKEN != '' && vars.TELEGRAM_CHAT_ID != ''
      run: |
        STATUS=${{ needs.deploy-ec2.result }}
        if [ "$STATUS" = "success" ]; then
          MESSAGE="✅ AutoCoin Backend 배포 성공\n브랜치: ${{ github.ref_name }}\n커밋: ${{ github.sha }}"
        else
          MESSAGE="❌ AutoCoin Backend 배포 실패\n브랜치: ${{ github.ref_name }}\n커밋: ${{ github.sha }}"
        fi
        
        curl -X POST \
          -H 'Content-Type: application/json' \
          -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\"}" \
          https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage