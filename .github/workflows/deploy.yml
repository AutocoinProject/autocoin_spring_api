name: AutoCoin Backend CI/CD

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Run tests
      run: ./gradlew test
      env:
        SPRING_PROFILES_ACTIVE: test
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: build/reports/tests/

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Build with Gradle
      run: ./gradlew build -x test
      env:
        SPRING_PROFILES_ACTIVE: prod
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: jar-artifacts
        path: build/libs/

  deploy-ec2:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: jar-artifacts
        path: build/libs/
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        debug: true
        timeout: 60m
        command_timeout: 30m
        script: |
          # 디버깅 출력 추가
          echo "Starting deployment process..."
          
          # 기존 프로세스 종료
          sudo pkill -f autocoin || echo "No existing process found to kill or kill failed"
          echo "Process termination attempted"
          
          # 새 JAR 파일 복사 준비
          mkdir -p ~/app && echo "App directory created successfully"
          
    - name: Copy JAR to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "build/libs/*.jar"
        target: "~/app/"
        strip_components: 2
    
    - name: Start application
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        debug: true
        timeout: 60m
        command_timeout: 30m
        script: |
          echo "Starting application deployment..."
          cd ~/app
          echo "Changed directory to ~/app"
          
          # 환경변수 설정
          echo "Setting environment variables..."
          export DB_USERNAME="${{ secrets.DB_USERNAME }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export DATABASE_URL="${{ secrets.DATABASE_URL }}"
          export JWT_SECRET="${{ secrets.JWT_SECRET }}"
          export UPBIT_ENCRYPTION_KEY="${{ secrets.UPBIT_ENCRYPTION_KEY }}"
          export AWS_ACCESS_KEY="${{ secrets.AWS_ACCESS_KEY }}"
          export AWS_SECRET_KEY="${{ secrets.AWS_SECRET_KEY }}"
          export AWS_S3_BUCKET="${{ secrets.AWS_S3_BUCKET }}"
          export AWS_REGION="${{ secrets.AWS_REGION }}"
          export GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
          export GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"
          export KAKAO_CLIENT_SECRET="${{ secrets.KAKAO_CLIENT_SECRET }}"
          export SERP_API_KEY="${{ secrets.SERP_API_KEY }}"
          echo "Environment variables set successfully"
          
          # 애플리케이션 시작
          echo "Starting application with java -jar..."
          mkdir -p /var/log/autocoin || echo "Log directory already exists"
          nohup java -jar *.jar \
            --spring.profiles.active=prod \
            > /var/log/autocoin/application.log 2>&1 &
          echo "Application started in background"
          
          # 헬스체크
          echo "Waiting 30 seconds before health check..."
          sleep 30
          echo "Performing health check..."
          curl -v http://localhost:8080/health || echo "Health check failed with exit code $?" || exit 1
          echo "Health check successful"
    
    - name: Health Check
      run: |
        sleep 10
        curl -f http://${{ secrets.EC2_HOST }}:8080/health

  deploy-render:
    needs: build
    runs-on: ubuntu-latest
    if: false  # 현재 비활성화
    # deploy-ec2와 동시에 실행되지 않도록 주석 처리
    # 필요시 deploy-ec2 대신 사용하거나 조건을 다르게 설정
    
    steps:
    - name: Deploy to Render
      run: |
        curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
    
    - name: Wait for deployment
      run: sleep 60
    
    - name: Health Check
      run: |
        # Render 앱 URL로 헬스체크
        curl -f https://your-render-app.onrender.com/health

  notify:
    needs: [deploy-ec2]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify Slack
      if: vars.SLACK_WEBHOOK != ''
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_CHANNEL: deployment
        SLACK_COLOR: ${{ needs.deploy-ec2.result == 'success' && 'good' || 'danger' }}
        SLACK_MESSAGE: |
          AutoCoin Backend Deployment ${{ needs.deploy-ec2.result }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
        SLACK_TITLE: Deployment Status
        SLACK_USERNAME: GitHub Actions
    
    - name: Notify Telegram
      if: vars.TELEGRAM_BOT_TOKEN != '' && vars.TELEGRAM_CHAT_ID != ''
      run: |
        STATUS=${{ needs.deploy-ec2.result }}
        if [ "$STATUS" = "success" ]; then
          MESSAGE="✅ AutoCoin Backend 배포 성공\n브랜치: ${{ github.ref_name }}\n커밋: ${{ github.sha }}"
        else
          MESSAGE="❌ AutoCoin Backend 배포 실패\n브랜치: ${{ github.ref_name }}\n커밋: ${{ github.sha }}"
        fi
        
        curl -X POST \
          -H 'Content-Type: application/json' \
          -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\"}" \
          https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage